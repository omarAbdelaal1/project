<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --success: #2ecc71;
        --danger: #e74c3c;
        --light: #ecf0f1;
        --dark: #34495e;
      }

      body {
        background-color: #f5f7fa;
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 250px;
        background-color: var(--primary);
        color: white;
        padding: 20px 0;
        transition: all 0.3s;
      }

      .sidebar-header {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-header h3 {
        margin-bottom: 5px;
      }

      .sidebar-header p {
        font-size: 14px;
        opacity: 0.7;
      }

      .menu {
        list-style: none;
        padding: 0;
        margin-top: 20px;
      }

      .menu li {
        padding: 10px 20px;
        cursor: pointer;
        transition: background 0.3s;
        display: flex;
        align-items: center;
      }

      .menu li:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .menu li.active {
        background-color: var(--secondary);
        font-weight: bold;
      }

      .menu-icon {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      /* Main Content Styles */
      .main-content {
        flex: 1;
        padding: 20px;
        transition: all 0.3s;
        overflow-y: auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }

      /* QR Button and Header Actions */
      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #qr-button {
        display: flex;
        align-items: center;
        background-color: var(--secondary);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      #qr-button:hover {
        background-color: #2980b9;
      }

      .search-bar {
        display: flex;
        background: white;
        border-radius: 4px;
        padding: 8px 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .search-bar input {
        border: none;
        outline: none;
        width: 250px;
        margin-left: 10px;
      }

      .search-icon {
        display: flex;
        align-items: center;
      }

      /* Section Styles */
      .section {
        display: none;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .section.active {
        display: block;
      }

      .section-header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        font-size: 1.25rem;
        color: var(--dark);
      }

      /* Dashboard Section */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin: 10px 0;
        color: var(--secondary);
      }

      .stat-label {
        color: #7f8c8d;
        font-size: 0.9rem;
      }

      .upcoming-appointments {
        margin-top: 30px;
      }

      .appointment-item {
        display: flex;
        padding: 15px;
        border-bottom: 1px solid #eee;
        align-items: center;
      }

      .appointment-time {
        flex: 0 0 120px;
        font-weight: bold;
      }

      .appointment-details {
        flex: 1;
      }

      .patient-name {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .appointment-type {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .appointment-actions {
        display: flex;
        gap: 10px;
      }

      /* Patients Section */
      .patients-list {
        width: 100%;
        border-collapse: collapse;
      }

      .patients-list th {
        background-color: #f8f9fa;
        padding: 12px 15px;
        text-align: left;
        font-weight: bold;
        color: var(--dark);
      }

      .patients-list td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
      }

      .patients-list tr:hover {
        background-color: #f5f7fa;
      }

      .patient-actions {
        display: flex;
        gap: 10px;
      }

      /* Medical Records Section */
      .record-search {
        margin-bottom: 20px;
      }

      .patient-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }

      .record-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }

      .record-tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
      }

      .record-tab.active {
        border-bottom: 2px solid var(--secondary);
        font-weight: bold;
        color: var(--secondary);
      }

      .record-content {
        display: none;
      }

      .record-content.active {
        display: block;
      }

      .add-record-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      /* Profile Section */
      .profile-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 30px;
      }

      .profile-sidebar {
        text-align: center;
      }

      .profile-image {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
        border: 5px solid white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .profile-name {
        font-size: 1.25rem;
        margin-bottom: 5px;
      }

      .profile-specialty {
        color: #7f8c8d;
        margin-bottom: 20px;
      }

      .profile-details {
        background-color: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--dark);
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      textarea {
        min-height: 100px;
        resize: vertical;
      }

      /* Button Styles */
      .btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: var(--secondary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .btn-primary {
        background-color: var(--secondary);
      }

      .btn-success {
        background-color: var(--success);
      }

      .btn-danger {
        background-color: var(--danger);
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .qr {
        position: relative;
        left: 25%;
      }

      /* QR Scanner Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .qr-scanner-container {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .scanner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #7f8c8d;
      }

      #video-container {
        position: relative;
        width: 100%;
        border: 3px solid #333;
        border-radius: 10px;
        overflow: hidden;
      }

      #qr-video {
        width: 100%;
        height: auto;
      }

      #result-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        width: 100%;
        min-height: 70px;
      }

      #open-link {
        display: none;
        margin-top: 10px;
      }

      #start-button {
        margin-top: 20px;
        width: 100%;
      }

      .status {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 15px;
        font-size: 12px;
      }

      #auto-open {
        margin-top: 10px;
        display: flex;
        align-items: center;
      }

      #auto-open input {
        margin-right: 8px;
        width: auto;
      }

      .content-link {
        color: #2196f3;
        text-decoration: underline;
        cursor: pointer;
      }

      /* AI Assistant */
      .ai-assistant {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: #2563eb;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        transition: transform 0.3s;
        z-index: 1000;
      }

      .ai-assistant:hover {
        transform: scale(1.1);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          position: static;
          height: auto;
        }

        .main-content {
          margin-left: 0;
        }

        .profile-container {
          grid-template-columns: 1fr;
        }

        .profile-sidebar {
          text-align: center;
          margin-bottom: 20px;
        }

        .header-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .qr-scanner-container {
          width: 95%;
          padding: 15px;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h3>Curinai</h3>
          <p>Doctor Dashboard</p>
        </div>
        <ul class="menu">
          <li class="active" data-section="dashboard-section">
            <span class="menu-icon">📊</span> Dashboard
          </li>
          <li data-section="patients-section">
            <span class="menu-icon">👥</span> Patients
          </li>
          <li data-section="medical-records-section">
            <span class="menu-icon">📋</span> Medical Records
          </li>
          <li data-section="profile-section">
            <span class="menu-icon">👨‍⚕️</span> My Profile
          </li>
          <li id="logout"><span class="menu-icon">🚪</span> Logout</li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Modified header with QR button -->
        <div class="header">
          <h2>Welcome back, Dr. Smith</h2>
          <div class="header-actions">
            <div class="search-bar">
              <span class="search-icon">🔍</span>
              <input type="text" placeholder="Search patients, records, etc." />
            </div>
            <button id="qr-button" class="btn btn-sm">
              <span style="margin-right: 5px">📷</span>Scan QR
            </button>
          </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section active">
          <div class="section-header">
            <h3 class="section-title">Dashboard Overview</h3>
            <div class="date">Tuesday, February 25, 2025</div>
          </div>

          <div class="stats-container">
            <div class="stat-card">
              <div class="stat-label">Today's Appointments</div>
              <div class="stat-value">8</div>
              <div>3 remaining</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Patients</div>
              <div class="stat-value">254</div>
              <div>+3 this week</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Pending Reports</div>
              <div class="stat-value">5</div>
              <div>2 urgent</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Messages</div>
              <div class="stat-value">12</div>
              <div>4 unread</div>
            </div>
          </div>

          <div class="upcoming-appointments">
            <div class="section-header">
              <h3 class="section-title">Today's Schedule</h3>
              <button class="btn btn-sm">View All</button>
            </div>

            <div class="appointment-item">
              <div class="appointment-time">09:00 AM</div>
              <div class="appointment-details">
                <div class="patient-name">John Anderson</div>
                <div class="appointment-type">Follow-up consultation</div>
              </div>
              <div class="appointment-actions">
                <button class="btn btn-sm">View Details</button>
                <button class="btn btn-sm btn-success">Start</button>
              </div>
            </div>

            <div class="appointment-item">
              <div class="appointment-time">10:30 AM</div>
              <div class="appointment-details">
                <div class="patient-name">Maria Rodriguez</div>
                <div class="appointment-type">New patient consultation</div>
              </div>
              <div class="appointment-actions">
                <button class="btn btn-sm">View Details</button>
                <button class="btn btn-sm btn-success">Start</button>
              </div>
            </div>

            <div class="appointment-item">
              <div class="appointment-time">01:00 PM</div>
              <div class="appointment-details">
                <div class="patient-name">Robert Johnson</div>
                <div class="appointment-type">Post-operative check</div>
              </div>
              <div class="appointment-actions">
                <button class="btn btn-sm">View Details</button>
                <button class="btn btn-sm btn-success">Start</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Patients Section -->
        <div id="patients-section" class="section">
          <div class="section-header">
            <h3 class="section-title">My Patients</h3>
            <button class="btn">Add New Patient</button>
          </div>

          <div class="search-bar" style="margin-bottom: 20px">
            <span class="search-icon">🔍</span>
            <input
              type="text"
              placeholder="Search patients by name, ID, or condition..."
            />
          </div>

          <table class="patients-list">
            <thead>
              <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Last Visit</th>
                <th>Condition</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>P-001</td>
                <td>John Anderson</td>
                <td>45</td>
                <td>Male</td>
                <td>Feb 20, 2025</td>
                <td>Hypertension</td>
                <td class="patient-actions">
                  <button class="btn btn-sm">View</button>
                  <button class="btn btn-sm">Records</button>
                </td>
              </tr>
              <tr>
                <td>P-002</td>
                <td>Maria Rodriguez</td>
                <td>38</td>
                <td>Female</td>
                <td>Feb 22, 2025</td>
                <td>Diabetes</td>
                <td class="patient-actions">
                  <button class="btn btn-sm">View</button>
                  <button class="btn btn-sm">Records</button>
                </td>
              </tr>
              <tr>
                <td>P-003</td>
                <td>Robert Johnson</td>
                <td>56</td>
                <td>Male</td>
                <td>Feb 18, 2025</td>
                <td>Post-surgery</td>
                <td class="patient-actions">
                  <button class="btn btn-sm">View</button>
                  <button class="btn btn-sm">Records</button>
                </td>
              </tr>
              <tr>
                <td>P-004</td>
                <td>Emily Chen</td>
                <td>29</td>
                <td>Female</td>
                <td>Feb 15, 2025</td>
                <td>Pregnancy</td>
                <td class="patient-actions">
                  <button class="btn btn-sm">View</button>
                  <button class="btn btn-sm">Records</button>
                </td>
              </tr>
              <tr>
                <td>P-005</td>
                <td>David Brown</td>
                <td>62</td>
                <td>Male</td>
                <td>Feb 10, 2025</td>
                <td>Arthritis</td>
                <td class="patient-actions">
                  <button class="btn btn-sm">View</button>
                  <button class="btn btn-sm">Records</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Medical Records Section -->
        <div id="medical-records-section" class="section">
          <div class="section-header">
            <h3 class="section-title">Medical Records</h3>
            <button class="btn" id="new-record-btn">Add New Record</button>
          </div>

          <div class="record-search">
            <div class="form-group">
              <label>Search Patient</label>
              <input
                type="text"
                placeholder="Enter patient name or ID"
                id="patient-search"
              />
            </div>
          </div>

          <div id="patient-record-view">
            <div class="patient-info">
              <div>
                <h4>Patient Information</h4>
                <p><strong>Name:</strong> John Anderson</p>
                <p><strong>ID:</strong> P-001</p>
                <p><strong>DOB:</strong> 05/12/1980 (45 years)</p>
                <p><strong>Gender:</strong> Male</p>
              </div>
              <div>
                <p><strong>Phone:</strong> (555) 123-4567</p>
                <p><strong>Email:</strong> john.anderson@example.com</p>
                <p><strong>Address:</strong> 123 Main St, Anytown, USA</p>
                <p><strong>Insurance:</strong> BlueCross #12345678</p>
              </div>
            </div>

            <div class="record-tabs">
              <div class="record-tab active" data-tab="medications">
                Medications
              </div>
              <div class="record-tab" data-tab="allergies">Allergies</div>
              <div class="record-tab" data-tab="conditions">Conditions</div>
              <div class="record-tab" data-tab="medical-tests">
                Medical Tests
              </div>
              <div class="record-tab" data-tab="x-rays">X-Rays</div>
              <div class="record-tab" data-tab="appointments">Appointments</div>
              <div class="record-tab" data-tab="notes">Notes</div>
            </div>

            <div id="medications" class="record-content active">
              <h4>Current Medications</h4>
              <table class="patients-list">
                <thead>
                  <tr>
                    <th>Medication</th>
                    <th>Dosage</th>
                    <th>Frequency</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Lisinopril</td>
                    <td>10mg</td>
                    <td>Once daily</td>
                    <td>Jan 15, 2025</td>
                    <td>Ongoing</td>
                    <td>
                      <button class="btn btn-sm">Edit</button>
                      <button class="btn btn-sm btn-danger">Stop</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Aspirin</td>
                    <td>81mg</td>
                    <td>Once daily</td>
                    <td>Jan 15, 2025</td>
                    <td>Ongoing</td>
                    <td>
                      <button class="btn btn-sm">Edit</button>
                      <button class="btn btn-sm btn-danger">Stop</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="allergies" class="record-content">
              <h4>Allergies</h4>
              <table class="patients-list">
                <thead>
                  <tr>
                    <th>Allergy</th>
                    <th>Severity</th>
                    <th>Reaction</th>
                    <th>Onset Date</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Peanuts</td>
                    <td>Severe</td>
                    <td>Anaphylaxis</td>
                    <td>Jan 15, 2022</td>
                    <td>Requires EpiPen at all times</td>
                    <td>
                      <button class="btn btn-sm">Edit</button>
                      <button class="btn btn-sm btn-danger">Remove</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Tree Nuts</td>
                    <td>Moderate</td>
                    <td>Hives, Swelling</td>
                    <td>Mar 10, 2023</td>
                    <td>Cross-reactivity with peanuts</td>
                    <td>
                      <button class="btn btn-sm">Edit</button>
                      <button class="btn btn-sm btn-danger">Remove</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="conditions" class="record-content">
              <h4>Medical Conditions</h4>
              <table class="patients-list">
                <thead>
                  <tr>
                    <th>Condition</th>
                    <th>Diagnosis Date</th>
                    <th>Status</th>
                    <th>Treating Physician</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Hypertension</td>
                    <td>Jan 10, 2025</td>
                    <td>Active</td>
                    <td>Dr. Smith</td>
                    <td>Controlled with medication</td>
                    <td>
                      <button class="btn btn-sm">Edit</button>
                      <button class="btn btn-sm btn-danger">Remove</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Hyperlipidemia</td>
                    <td>Feb 20, 2025</td>
                    <td>Active</td>
                    <td>Dr. Johnson</td>
                    <td>Diet and medication management</td>
                    <td>
                      <button class="btn btn-sm">Edit</button>
                      <button class="btn btn-sm btn-danger">Remove</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="medical-tests" class="record-content">
              <h4>Medical Tests</h4>
              <table class="patients-list">
                <thead>
                  <tr>
                    <th>Test</th>
                    <th>Date</th>
                    <th>Result</th>
                    <th>Reference Range</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Complete Blood Count (CBC)</td>
                    <td>Feb 18, 2025</td>
                    <td>WBC: 7.2 × 10^9/L</td>
                    <td>4.5-11.0 × 10^9/L</td>
                    <td>Normal</td>
                    <td>
                      <button class="btn btn-sm">View Full Report</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Lipid Profile</td>
                    <td>Feb 18, 2025</td>
                    <td>Total Cholesterol: 210 mg/dL</td>
                    <td><200 mg/dL</td>
                    <td>Borderline High</td>
                    <td>
                      <button class="btn btn-sm">View Full Report</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="x-rays" class="record-content">
              <h4>X-Rays</h4>
              <table class="patients-list">
                <thead>
                  <tr>
                    <th>X-Ray Type</th>
                    <th>Date</th>
                    <th>Body Part</th>
                    <th>Result</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Chest X-Ray</td>
                    <td>Feb 20, 2025</td>
                    <td>Thoracic Cavity</td>
                    <td>Normal</td>
                    <td>
                      <button class="btn btn-sm">View Full Report</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Abdominal X-Ray</td>
                    <td>Feb 22, 2025</td>
                    <td>Abdomen</td>
                    <td>Abnormal</td>
                    <td>
                      <button class="btn btn-sm">View Full Report</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="appointments" class="record-content">
              <h4>Appointments</h4>
              <table class="patients-list">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Feb 25, 2025</td>
                    <td>09:00 AM</td>
                    <td>Follow-up consultation</td>
                    <td>
                      <button class="btn btn-sm">View Details</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Feb 27, 2025</td>
                    <td>10:30 AM</td>
                    <td>New patient consultation</td>
                    <td>
                      <button class="btn btn-sm">View Details</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="notes" class="record-content">
              <h4>Clinical Notes</h4>
              <div class="appointment-item">
                <div class="appointment-time">Feb 20, 2025</div>
                <div class="appointment-details">
                  <div class="patient-name">Follow-up Notes</div>
                  <div class="appointment-type">
                    <p>
                      Patient reports feeling better with the new medication.
                      Still experiencing occasional headaches in the morning.
                      Advised to monitor and track occurrences. Will reassess in
                      one month.
                    </p>
                  </div>
                </div>
              </div>
              <div class="appointment-item">
                <div class="appointment-time">Jan 15, 2025</div>
                <div class="appointment-details">
                  <div class="patient-name">Annual Physical Notes</div>
                  <div class="appointment-type">
                    <p>
                      Patient is generally healthy but blood pressure remains
                      elevated. Started on Lisinopril 10mg daily. Discussed
                      importance of diet and exercise. Patient committed to
                      daily walks and reducing sodium intake.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="add-record-form" style="display: none">
            <div class="section-header">
              <h3 class="section-title">Add New Medical Record</h3>
              <button class="btn btn-danger" id="cancel-record-btn">
                Cancel
              </button>
            </div>

            <div class="form-group">
              <label>Patient</label>
              <select>
                <option>Select Patient</option>
                <option>John Anderson (P-001)</option>
                <option>Maria Rodriguez (P-002)</option>
                <option>Robert Johnson (P-003)</option>
                <option>Emily Chen (P-004)</option>
                <option>David Brown (P-005)</option>
              </select>
            </div>

            <div class="form-group">
              <label>Record Type</label>
              <select id="record-type-select">
                <option value="information">Information</option>
                <option value="medication">Medication</option>
                <option value="allergy">Allergy</option>
                <option value="condition">Medical Condition</option>
                <option value="test">Medical Test</option>
                <option value="xray">X-Ray</option>
                <option value="appointment">Appointment</option>
                <option value="note">Clinical Note</option>
              </select>
            </div>

            <!-- Information Form (Default - Replaces Visit form) -->
            <div id="information-form" class="add-record-form">
              <div class="form-group">
                <label>Record Date</label>
                <input type="date" value="2025-02-25" />
              </div>
              <div class="form-group">
                <label>Blood Pressure (mmHg)</label>
                <input type="text" placeholder="e.g., 120/80" required />
              </div>
              <div class="form-group">
                <label>Heart Rate (bpm)</label>
                <input type="number" placeholder="e.g., 72" required />
              </div>
              <div class="form-group">
                <label>Temperature (°C)</label>
                <input
                  type="number"
                  step="0.1"
                  placeholder="e.g., 36.8"
                  required
                />
              </div>
              <div class="form-group">
                <label>Weight (kg)</label>
                <input
                  type="number"
                  step="0.1"
                  placeholder="e.g., 75.5"
                  required
                />
              </div>
              <div class="form-group">
                <label>Height (cm)</label>
                <input type="number" placeholder="e.g., 175" required />
              </div>
              <div class="form-group">
                <label>BMI</label>
                <input
                  type="number"
                  step="0.01"
                  placeholder="Calculated automatically"
                  id="bmi-value"
                  readonly
                />
              </div>
              <div class="form-group">
                <label>Blood Type</label>
                <select required>
                  <option value="">Select blood type</option>
                  <option>A+</option>
                  <option>A-</option>
                  <option>B+</option>
                  <option>B-</option>
                  <option>AB+</option>
                  <option>AB-</option>
                  <option>O+</option>
                  <option>O-</option>
                  <option>Unknown</option>
                </select>
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea placeholder="Additional notes"></textarea>
              </div>
            </div>

            <!-- Add new medication form -->
            <div
              id="medication-form"
              class="add-record-form"
              style="display: none"
            >
              <div class="form-group">
                <label>Medication Name</label>
                <input type="text" placeholder="Medication name" required />
              </div>
              <div class="form-group">
                <label>Dosage</label>
                <input type="text" placeholder="e.g., 10mg" required />
              </div>
              <div class="form-group">
                <label>Frequency</label>
                <select required>
                  <option value="">Select frequency</option>
                  <option>Once daily</option>
                  <option>Twice daily</option>
                  <option>Three times daily</option>
                  <option>Every other day</option>
                  <option>Weekly</option>
                  <option>As needed</option>
                </select>
              </div>
              <div class="form-group">
                <label>Start Date</label>
                <input type="date" value="2025-02-25" required />
              </div>
              <div class="form-group">
                <label>End Date</label>
                <input type="date" placeholder="Leave blank if ongoing" />
              </div>
              <div class="form-group">
                <label>Special Instructions</label>
                <textarea
                  placeholder="Special instructions for taking this medication"
                ></textarea>
              </div>
            </div>

            <!-- Add allergy form -->
            <div
              id="allergy-form"
              class="add-record-form"
              style="display: none"
            >
              <div class="form-group">
                <label>Allergy</label>
                <input type="text" placeholder="Allergen name" required />
              </div>
              <div class="form-group">
                <label>Severity</label>
                <select required>
                  <option value="">Select severity</option>
                  <option>Mild</option>
                  <option>Moderate</option>
                  <option>Severe</option>
                </select>
              </div>
              <div class="form-group">
                <label>Reaction</label>
                <input
                  type="text"
                  placeholder="e.g., Anaphylaxis, Hives"
                  required
                />
              </div>
              <div class="form-group">
                <label>Onset Date</label>
                <input type="date" value="2025-02-25" required />
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea
                  placeholder="Additional details about this allergy"
                ></textarea>
              </div>
            </div>

            <!-- Add medical condition form -->
            <div
              id="condition-form"
              class="add-record-form"
              style="display: none"
            >
              <div class="form-group">
                <label>Condition</label>
                <input type="text" placeholder="Medical condition" required />
              </div>
              <div class="form-group">
                <label>Diagnosis Date</label>
                <input type="date" value="2025-02-25" required />
              </div>
              <div class="form-group">
                <label>Status</label>
                <select required>
                  <option value="">Select status</option>
                  <option>Active</option>
                  <option>In Remission</option>
                  <option>Resolved</option>
                  <option>Chronic</option>
                </select>
              </div>
              <div class="form-group">
                <label>Treating Physician</label>
                <input
                  type="text"
                  placeholder="Doctor's name"
                  value="Dr. Jane Smith"
                />
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea
                  placeholder="Additional details about this condition"
                ></textarea>
              </div>
            </div>

            <!-- Add medical test form -->
            <div id="test-form" class="add-record-form" style="display: none">
              <div class="form-group">
                <label>Test Name</label>
                <input type="text" placeholder="Medical test name" required />
              </div>
              <div class="form-group">
                <label>Test Date</label>
                <input type="date" value="2025-02-25" required />
              </div>
              <div class="form-group">
                <label>Result</label>
                <input type="text" placeholder="Test result" />
              </div>
              <div class="form-group">
                <label>Reference Range</label>
                <input type="text" placeholder="Normal range for this test" />
              </div>
              <div class="form-group">
                <label>Status</label>
                <select>
                  <option value="">Select status</option>
                  <option>Normal</option>
                  <option>Abnormal</option>
                  <option>Inconclusive</option>
                  <option>Pending</option>
                </select>
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea placeholder="Additional test information"></textarea>
              </div>
            </div>

            <!-- Add X-Ray form -->
            <div id="xray-form" class="add-record-form" style="display: none">
              <div class="form-group">
                <label>X-Ray Type</label>
                <input type="text" placeholder="Type of X-Ray" required />
              </div>
              <div class="form-group">
                <label>Date</label>
                <input type="date" value="2025-02-25" required />
              </div>
              <div class="form-group">
                <label>Body Part</label>
                <input type="text" placeholder="Body part imaged" required />
              </div>
              <div class="form-group">
                <label>Result</label>
                <select required>
                  <option value="">Select result</option>
                  <option>Normal</option>
                  <option>Abnormal</option>
                  <option>Inconclusive</option>
                </select>
              </div>
              <div class="form-group">
                <label>Report Details</label>
                <textarea
                  placeholder="Detailed findings from the X-Ray"
                ></textarea>
              </div>
            </div>

            <!-- Add appointment form -->
            <div
              id="appointment-form"
              class="add-record-form"
              style="display: none"
            >
              <div class="form-group">
                <label>Date</label>
                <input type="date" value="2025-02-25" required />
              </div>
              <div class="form-group">
                <label>Time</label>
                <input type="time" value="09:00" required />
              </div>
              <div class="form-group">
                <label>Appointment Type</label>
                <select required>
                  <option value="">Select type</option>
                  <option>New patient consultation</option>
                  <option>Follow-up consultation</option>
                  <option>Annual check-up</option>
                  <option>Emergency visit</option>
                  <option>Procedure</option>
                  <option>Specialist referral</option>
                </select>
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea
                  placeholder="Additional appointment details"
                ></textarea>
              </div>
            </div>

            <!-- Add clinical note form -->
            <div id="note-form" class="add-record-form" style="display: none">
              <div class="form-group">
                <label>Date</label>
                <input type="date" value="2025-02-25" required />
              </div>
              <div class="form-group">
                <label>Note Title</label>
                <input type="text" placeholder="Title for this note" required />
              </div>
              <div class="form-group">
                <label>Clinical Notes</label>
                <textarea
                  rows="6"
                  placeholder="Detailed clinical notes"
                ></textarea>
              </div>
            </div>

            <button class="btn btn-primary">Save Record</button>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="section">
          <div class="section-header">
            <h3 class="section-title">My Profile</h3>
            <button class="btn" id="edit-profile-btn">Edit Profile</button>
          </div>

          <div class="profile-container">
            <div class="profile-sidebar">
              <img
                src="/Digital_Health/m.jpg"
                alt="Dr. Smith"
                class="profile-image"
              />
              <h3 class="profile-name">Dr. Jane Smith</h3>
              <p class="profile-specialty">Cardiologist</p>
              <button class="btn">Change Photo</button>
            </div>

            <div class="profile-details">
              <div id="profile-view">
                <h4 style="margin-bottom: 20px">Personal Information</h4>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 20px;
                  "
                >
                  <div>
                    <p><strong>Full Name:</strong> Dr. Jane Smith</p>
                    <p><strong>Email:</strong> jane.smith@medportal.com</p>
                    <p><strong>Phone:</strong> (555) 987-6543</p>
                    <p><strong>Date of Birth:</strong> 04/15/1980</p>
                  </div>
                  <div>
                    <p><strong>Medical License:</strong> ML12345678</p>
                    <p><strong>Specialty:</strong> Cardiology</p>
                    <p><strong>Department:</strong> Cardiac Care</p>
                    <p>
                      <strong>Office Location:</strong> Building A, Floor A,
                      Room 123
                    </p>
                  </div>
                </div>

                <h4 style="margin: 30px 0 20px">Professional Information</h4>
                <div style="margin-bottom: 30px">
                  <p>
                    <strong>Education:</strong> Harvard Medical School, MD
                    (2005)
                  </p>
                  <p>
                    <strong>Residency:</strong> Massachusetts General Hospital
                    (2005-2009)
                  </p>
                  <p>
                    <strong>Board Certification:</strong> American Board of
                    Internal Medicine, Cardiovascular Disease
                  </p>
                  <p><strong>Languages:</strong> English, Spanish</p>
                </div>

                <h4 style="margin-bottom: 20px">Schedule Information</h4>
                <div style="margin-bottom: 30px">
                  <p>
                    <strong>Working Hours:</strong> Mon-Fri, 8:00 AM - 5:00 PM
                  </p>
                  <p><strong>Consultation Duration:</strong> 30 minutes</p>
                  <p><strong>Available for Emergency:</strong> Yes</p>
                </div>
              </div>

              <div id="profile-edit" style="display: none">
                <h4 style="margin-bottom: 20px">Edit Profile Information</h4>
                <div class="add-record-form">
                  <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" value="Dr. Jane Smith" />
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" value="jane.smith@medportal.com" />
                  </div>
                  <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" value="(555) 987-6543" />
                  </div>
                  <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" value="1980-04-15" />
                  </div>
                  <div class="form-group">
                    <label>Medical License</label>
                    <input type="text" value="ML12345678" />
                  </div>
                  <div class="form-group">
                    <label>Specialty</label>
                    <select>
                      <option>Cardiology</option>
                      <option>Neurology</option>
                      <option>Orthopedics</option>
                      <option>Pediatrics</option>
                      <option>General Practice</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Department</label>
                    <input type="text" value="Cardiac Care" />
                  </div>
                  <div class="form-group">
                    <label>Office Location</label>
                    <input type="text" value="Building A, Floor 1, Room 123" />
                  </div>
                  <div class="form-group">
                    <label>Education</label>
                    <textarea>Harvard Medical School, MD (2005)</textarea>
                  </div>
                  <div class="form-group">
                    <label>Residency</label>
                    <input
                      type="text"
                      value="Massachusetts General Hospital (2005-2009)"
                    />
                  </div>
                  <div class="form-group">
                    <label>Board Certification</label>
                    <input
                      type="text"
                      value="American Board of Internal Medicine, Cardiovascular Disease"
                    />
                  </div>
                  <div class="form-group">
                    <label>Languages</label>
                    <input type="text" value="English, Spanish" />
                  </div>
                  <div class="form-group">
                    <label>Working Hours</label>
                    <input type="text" value="Mon-Fri, 8:00 AM - 5:00 PM" />
                  </div>
                  <div class="form-group">
                    <label>Consultation Duration</label>
                    <select>
                      <option>15 minutes</option>
                      <option selected>30 minutes</option>
                      <option>45 minutes</option>
                      <option>60 minutes</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Available for Emergency</label>
                    <select>
                      <option selected>Yes</option>
                      <option>No</option>
                    </select>
                  </div>
                </div>
                <div style="display: flex; gap: 10px">
                  <button class="btn btn-primary">Save Changes</button>
                  <button class="btn btn-danger" id="cancel-edit-btn">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal QR scanner -->
    <div id="qr-scanner-modal" class="modal-overlay">
      <div class="qr-scanner-container">
        <div class="scanner-header">
          <h3>QR Code Scanner</h3>
          <button id="close-scanner" class="close-btn">&times;</button>
        </div>
        <div id="video-container">
          <video id="qr-video" playsinline></video>
          <div class="status" id="camera-status">Ready</div>
        </div>
        <div id="result-container">
          <div id="result">Scan a QR code to see result</div>
          <div id="auto-open">
            <input type="checkbox" id="auto-open-toggle" checked />
            <label for="auto-open-toggle"
              >Automatically open URLs when scanned</label
            >
          </div>
          <button id="open-link" class="btn">Open Link</button>
        </div>
        <button id="start-button" class="btn btn-primary">Start Camera</button>
      </div>
    </div>

    <!-- AI Assistant Fixed Button -->
    <div class="ai-assistant" onclick="openAIAssistant()">AI</div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
      // Mock data structures
      const patients = [
        {
          id: "P-001",
          name: "John Anderson",
          age: 45,
          gender: "Male",
          dob: "1980-05-12",
          lastVisit: "2025-02-20",
          condition: "Hypertension",
          phone: "(555) 123-4567",
          email: "john.anderson@example.com",
          address: "123 Main St, Anytown, USA",
          insurance: "BlueCross #12345678",
        },
        {
          id: "P-002",
          name: "Maria Rodriguez",
          age: 38,
          gender: "Female",
          dob: "1987-07-23",
          lastVisit: "2025-02-22",
          condition: "Diabetes",
          phone: "(555) 234-5678",
          email: "maria.rodriguez@example.com",
          address: "456 Oak Ave, Anytown, USA",
          insurance: "Aetna #87654321",
        },
        {
          id: "P-003",
          name: "Robert Johnson",
          age: 56,
          gender: "Male",
          dob: "1969-11-05",
          lastVisit: "2025-02-18",
          condition: "Post-surgery",
          phone: "(555) 345-6789",
          email: "robert.johnson@example.com",
          address: "789 Pine St, Anytown, USA",
          insurance: "Medicare #23456789",
        },
        {
          id: "P-004",
          name: "Emily Chen",
          age: 29,
          gender: "Female",
          dob: "1996-03-15",
          lastVisit: "2025-02-15",
          condition: "Pregnancy",
          phone: "(555) 456-7890",
          email: "emily.chen@example.com",
          address: "321 Maple Dr, Anytown, USA",
          insurance: "UnitedHealth #34567890",
        },
        {
          id: "P-005",
          name: "David Brown",
          age: 62,
          gender: "Male",
          dob: "1963-09-28",
          lastVisit: "2025-02-10",
          condition: "Arthritis",
          phone: "(555) 567-8901",
          email: "david.brown@example.com",
          address: "654 Cedar Ln, Anytown, USA",
          insurance: "Cigna #45678901",
        },
      ];

      const appointments = [
        {
          id: "A-001",
          patientId: "P-001",
          time: "09:00 AM",
          date: "2025-02-25",
          type: "Follow-up consultation",
          status: "Scheduled",
        },
        {
          id: "A-002",
          patientId: "P-002",
          time: "10:30 AM",
          date: "2025-02-25",
          type: "New patient consultation",
          status: "Scheduled",
        },
        {
          id: "A-003",
          patientId: "P-003",
          time: "01:00 PM",
          date: "2025-02-25",
          type: "Post-operative check",
          status: "Scheduled",
        },
      ];

      const medicalRecords = {
        "P-001": {
          medicalHistory: [
            {
              date: "2025-02-20",
              title: "Hypertension Follow-up",
              details: [
                "Blood pressure: 140/85 mmHg",
                "Patient reports occasional headaches. Medication adjusted.",
              ],
            },
            {
              date: "2025-01-15",
              title: "Annual Physical",
              details: [
                "Blood pressure: 145/90 mmHg",
                "Cholesterol: 210 mg/dL",
                "Patient advised on dietary changes.",
              ],
            },
          ],
          medications: [
            {
              name: "Lisinopril",
              dosage: "10mg",
              frequency: "Once daily",
              startDate: "2025-01-15",
              endDate: "Ongoing",
            },
            {
              name: "Aspirin",
              dosage: "81mg",
              frequency: "Once daily",
              startDate: "2025-01-15",
              endDate: "Ongoing",
            },
          ],
          labResults: [
            {
              date: "2025-02-18",
              test: "Blood Glucose",
              result: "95 mg/dL",
              range: "70-99 mg/dL",
            },
            {
              date: "2025-02-18",
              test: "Cholesterol - Total",
              result: "210 mg/dL",
              range: "<200 mg/dL",
            },
            {
              date: "2025-01-15",
              test: "CBC",
              result: "Normal",
              range: "-",
            },
          ],
          notes: [
            {
              date: "2025-02-20",
              title: "Follow-up Notes",
              content:
                "Patient reports feeling better with the new medication. Still experiencing occasional headaches in the morning. Advised to monitor and track occurrences. Will reassess in one month.",
            },
            {
              date: "2025-01-15",
              title: "Annual Physical Notes",
              content:
                "Patient is generally healthy but blood pressure remains elevated. Started on Lisinopril 10mg daily. Discussed importance of diet and exercise. Patient committed to daily walks and reducing sodium intake.",
            },
          ],
          information: [
            {
              date: "2025-02-20",
              bloodPressure: "140/85",
              heartRate: 72,
              temperature: 36.8,
              weight: 82.3,
              height: 178,
              bmi: 26.0,
              bloodType: "A+",
              notes:
                "Patient is showing improvement in blood pressure control.",
            },
            {
              date: "2025-01-15",
              bloodPressure: "145/90",
              heartRate: 78,
              temperature: 36.6,
              weight: 83.5,
              height: 178,
              bmi: 26.4,
              bloodType: "A+",
              notes:
                "Initial assessment. Starting on blood pressure medication.",
            },
          ],
        },
      };

      // Current user data
      const doctorProfile = {
        name: "Dr. Jane Smith",
        email: "jane.smith@medportal.com",
        phone: "(555) 987-6543",
        dob: "1980-04-15",
        license: "ML12345678",
        specialty: "Cardiology",
        department: "Cardiac Care",
        office: "Building A, Floor 1, Room 123",
        education: "Harvard Medical School, MD (2005)",
        residency: "Massachusetts General Hospital (2005-2009)",
        certification:
          "American Board of Internal Medicine, Cardiovascular Disease",
        languages: "English, Spanish",
        workingHours: "Mon-Fri, 8:00 AM - 5:00 PM",
        consultationDuration: "30 minutes",
        availableForEmergency: "Yes",
      };

      // DOM elements for notifications and modals
      let notificationContainer;
      let modalContainer;

      // Initialization function
      function initializeDashboard() {
        // Create notification container
        createNotificationContainer();

        // Create modal container
        createModalContainer();

        // Set current date in the dashboard
        const today = new Date();
        const options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };
        document.querySelector("#dashboard-section .date").textContent =
          today.toLocaleDateString("en-US", options);

        // Initialize menu navigation
        initializeNavigation();

        // Initialize record tabs
        initializeRecordTabs();

        // Initialize form toggles
        initializeFormToggles();

        // Initialize patient search
        initializePatientSearch();

        // Initialize record type selection
        initializeRecordTypeSelection();

        // Initialize action buttons
        initializeActionButtons();

        // Initialize patient table
        renderPatientTable(patients);

        // Initialize QR Scanner functionality
        initializeQRScanner();

        // Initialize BMI calculator
        initializeBMICalculator();
      }

      // Initialize BMI Calculator
      function initializeBMICalculator() {
        const weightInput = document.querySelector(
          "#information-form input[placeholder='e.g., 75.5']"
        );
        const heightInput = document.querySelector(
          "#information-form input[placeholder='e.g., 175']"
        );
        const bmiInput = document.querySelector("#bmi-value");

        const calculateBMI = () => {
          const weight = parseFloat(weightInput.value);
          const height = parseFloat(heightInput.value);

          if (weight && height) {
            // BMI = weight (kg) / (height (m))²
            const heightInMeters = height / 100;
            const bmi = weight / (heightInMeters * heightInMeters);
            bmiInput.value = bmi.toFixed(2);
          } else {
            bmiInput.value = "";
          }
        };

        weightInput.addEventListener("input", calculateBMI);
        heightInput.addEventListener("input", calculateBMI);
      }

      // Create notification container
      function createNotificationContainer() {
        notificationContainer = document.createElement("div");
        notificationContainer.className = "notification-container";
        notificationContainer.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
  `;
        document.body.appendChild(notificationContainer);
      }

      // Create modal container
      function createModalContainer() {
        modalContainer = document.createElement("div");
        modalContainer.className = "modal-container";
        modalContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  `;
        document.body.appendChild(modalContainer);
      }

      // Show notification
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;

        // Set styles based on notification type
        const bgColor =
          type === "success"
            ? "#2ecc71"
            : type === "error"
            ? "#e74c3c"
            : type === "warning"
            ? "#f39c12"
            : "#3498db";

        notification.style.cssText = `
    background-color: ${bgColor};
    color: white;
    padding: 15px 20px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 10px;
    animation: fadeIn 0.3s ease-out;
    max-width: 300px;
  `;

        notification.innerHTML = message;

        notificationContainer.appendChild(notification);

        // Remove notification after 4 seconds
        setTimeout(() => {
          notification.style.animation = "fadeOut 0.3s ease-out";
          notification.addEventListener("animationend", () => {
            notification.remove();
          });
        }, 4000);
      }

      // Show modal dialog
      function showModal(title, content, buttons = []) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.cssText = `
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  `;

        // Modal header
        const modalHeader = document.createElement("div");
        modalHeader.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  `;

        const modalTitle = document.createElement("h3");
        modalTitle.textContent = title;
        modalTitle.style.margin = "0";

        const closeButton = document.createElement("button");
        closeButton.innerHTML = "&times;";
        closeButton.style.cssText = `
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #7f8c8d;
  `;
        closeButton.onclick = () => {
          modalContainer.style.display = "none";
          modal.remove();
        };

        modalHeader.appendChild(modalTitle);
        modalHeader.appendChild(closeButton);

        // Modal content
        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";
        modalContent.style.marginBottom = "20px";

        if (typeof content === "string") {
          modalContent.innerHTML = content;
        } else {
          modalContent.appendChild(content);
        }

        // Modal footer with buttons
        const modalFooter = document.createElement("div");
        modalFooter.style.cssText = `
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  `;

        buttons.forEach((button) => {
          const btn = document.createElement("button");
          btn.textContent = button.text;
          btn.className = `btn ${button.class || ""}`;
          btn.onclick = () => {
            if (button.handler) {
              button.handler();
            }
            if (button.closeModal !== false) {
              modalContainer.style.display = "none";
              modal.remove();
            }
          };
          modalFooter.appendChild(btn);
        });

        // Add all elements to modal
        modal.appendChild(modalHeader);
        modal.appendChild(modalContent);
        modal.appendChild(modalFooter);

        // Clear previous modal content and show the new one
        modalContainer.innerHTML = "";
        modalContainer.appendChild(modal);
        modalContainer.style.display = "flex";

        // Close modal when clicking outside
        modalContainer.onclick = (event) => {
          if (event.target === modalContainer) {
            modalContainer.style.display = "none";
            modal.remove();
          }
        };

        return modal;
      }

      // Confirmation dialog
      function showConfirmDialog(message, onConfirm, onCancel) {
        showModal("Confirmation", `<p>${message}</p>`, [
          {
            text: "Cancel",
            class: "btn-danger",
            handler: onCancel || function () {},
          },
          {
            text: "Confirm",
            class: "btn-primary",
            handler: onConfirm,
          },
        ]);
      }

      // Add patient form
      function createAddPatientForm() {
        const form = document.createElement("form");
        form.innerHTML = `
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" required>
    </div>
    <div class="form-group">
      <label>Date of Birth</label>
      <input type="date" required>
    </div>
    <div class="form-group">
      <label>Gender</label>
      <select required>
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group">
      <label>Phone</label>
      <input type="tel">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email">
    </div>
    <div class="form-group">
      <label>Address</label>
      <textarea></textarea>
    </div>
    <div class="form-group">
      <label>Insurance Details</label>
      <input type="text">
    </div>
    <div class="form-group">
      <label>Medical Condition</label>
      <input type="text">
    </div>
  `;
        return form;
      }

      // Navigation between sections
      function initializeNavigation() {
        document.querySelectorAll(".menu li").forEach((item) => {
          item.addEventListener("click", function () {
            // Handle logout separately
            if (this.id === "logout") {
              showConfirmDialog(
                "Are you sure you want to log out?",
                function () {
                  // Show a message before redirecting
                  showNotification(
                    "You've been logged out. Redirecting to login page...",
                    "info"
                  );

                  // In a real app, perform actual logout and redirect
                  setTimeout(() => {
                    // window.location.href = "login.html";
                    // For now, just redirect to the top of the page
                    window.location.href = "#";
                  }, 2000);
                }
              );
              return;
            }

            // Update active menu item
            document.querySelectorAll(".menu li").forEach((li) => {
              li.classList.remove("active");
            });
            this.classList.add("active");

            // Show corresponding section
            const sectionId = this.getAttribute("data-section");
            document.querySelectorAll(".section").forEach((section) => {
              section.classList.remove("active");
            });
            document.getElementById(sectionId).classList.add("active");
          });
        });
      }

      // Initialize QR Scanner
      function initializeQRScanner() {
        const qrButton = document.getElementById("qr-button");
        const qrScannerModal = document.getElementById("qr-scanner-modal");
        const closeScanner = document.getElementById("close-scanner");
        const video = document.getElementById("qr-video");
        const resultElement = document.getElementById("result");
        const openLinkButton = document.getElementById("open-link");
        const startButton = document.getElementById("start-button");
        const cameraStatus = document.getElementById("camera-status");
        const autoOpenToggle = document.getElementById("auto-open-toggle");

        let scanning = false;
        let lastResult = "";
        let lastScannedTime = 0;

        // Open QR scanner modal
        qrButton.addEventListener("click", function () {
          qrScannerModal.style.display = "flex";
        });

        // Close QR scanner modal
        closeScanner.addEventListener("click", function () {
          qrScannerModal.style.display = "none";
          // Stop camera if it's running
          if (scanning) {
            stopScanning();
            startButton.textContent = "Start Camera";
            cameraStatus.textContent = "Ready";
            scanning = false;
          }
        });

        // Close modal when clicking outside the scanner container
        qrScannerModal.addEventListener("click", function (event) {
          if (event.target === qrScannerModal) {
            qrScannerModal.style.display = "none";
            // Stop camera if it's running
            if (scanning) {
              stopScanning();
              startButton.textContent = "Start Camera";
              cameraStatus.textContent = "Ready";
              scanning = false;
            }
          }
        });

        // Start/stop camera button
        startButton.addEventListener("click", function () {
          if (scanning) {
            stopScanning();
            startButton.textContent = "Start Camera";
            cameraStatus.textContent = "Ready";
          } else {
            startCamera();
            startButton.textContent = "Stop Camera";
            cameraStatus.textContent = "Scanning...";
          }
          scanning = !scanning;
        });

        // Open link button
        openLinkButton.addEventListener("click", function () {
          openDetectedContent(lastResult);
        });

        // Start camera function
        async function startCamera() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" },
            });

            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();

            requestAnimationFrame(scanQRCode);
          } catch (error) {
            resultElement.textContent = `Error accessing camera: ${error.message}`;
            cameraStatus.textContent = "Error";
            scanning = false;
            startButton.textContent = "Start Camera";
          }
        }

        // Stop scanning function
        function stopScanning() {
          const stream = video.srcObject;
          if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop());
            video.srcObject = null;
          }
        }

        // Check if a string is a valid URL
        function isValidURL(string) {
          try {
            new URL(string);
            return true;
          } catch (_) {
            return false;
          }
        }

        // Scan QR code function
        function scanQRCode() {
          if (!scanning) return;

          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const canvas = document.createElement("canvas");
            const canvasContext = canvas.getContext("2d");
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = canvasContext.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const code = jsQR(
              imageData.data,
              imageData.width,
              imageData.height,
              {
                inversionAttempts: "dontInvert",
              }
            );

            if (code) {
              const currentTime = new Date().getTime();
              // Only process new results or if more than 2 seconds have passed
              if (
                code.data !== lastResult ||
                currentTime - lastScannedTime > 2000
              ) {
                lastResult = code.data;
                lastScannedTime = currentTime;
                processQRContent(code.data);
              }
            }
          }

          requestAnimationFrame(scanQRCode);
        }

        // Process QR content
        function processQRContent(content) {
          // Display the raw content
          if (isValidURL(content)) {
            // If it's a URL, make it clickable
            resultElement.innerHTML = `Detected URL: <span class="content-link" onclick="window.open('${content}', '_blank')">${content}</span>`;
            openLinkButton.style.display = "block";

            // Auto-open if the checkbox is checked
            if (autoOpenToggle.checked) {
              openDetectedContent(content);
            }
          } else {
            // If it's not a URL, just display the content
            resultElement.textContent = `Detected content: ${content}`;
            openLinkButton.style.display = "none";

            // Check if it looks like a URL without protocol and open it if auto-open is enabled
            if (
              autoOpenToggle.checked &&
              content.includes(".") &&
              !content.includes(" ")
            ) {
              openDetectedContent("https://" + content);
            }
          }
        }

        // Open detected content
        function openDetectedContent(content) {
          if (isValidURL(content)) {
            window.open(content, "_blank");
          } else if (content.includes(".") && !content.includes(" ")) {
            window.open("https://" + content, "_blank");
          }
        }
      }

      // Record tabs navigation
      function initializeRecordTabs() {
        document.querySelectorAll(".record-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabId = this.getAttribute("data-tab");

            // Update active tab
            document.querySelectorAll(".record-tab").forEach((t) => {
              t.classList.remove("active");
            });
            this.classList.add("active");

            // Show corresponding content
            document.querySelectorAll(".record-content").forEach((content) => {
              content.classList.remove("active");
            });
            document.getElementById(tabId).classList.add("active");
          });
        });
      }

      // Form toggles
      function initializeFormToggles() {
        // Toggle add new record form
        document
          .getElementById("new-record-btn")
          .addEventListener("click", function () {
            document.getElementById("patient-record-view").style.display =
              "none";
            document.getElementById("add-record-form").style.display = "block";
          });

        document
          .getElementById("cancel-record-btn")
          .addEventListener("click", function () {
            document.getElementById("patient-record-view").style.display =
              "block";
            document.getElementById("add-record-form").style.display = "none";
          });

        // Toggle edit profile form
        document
          .getElementById("edit-profile-btn")
          .addEventListener("click", function () {
            document.getElementById("profile-view").style.display = "none";
            document.getElementById("profile-edit").style.display = "block";
          });

        document
          .getElementById("cancel-edit-btn")
          .addEventListener("click", function () {
            document.getElementById("profile-view").style.display = "block";
            document.getElementById("profile-edit").style.display = "none";
          });

        // Add event listener for the "Add New Patient" button
        document
          .querySelector("#patients-section .btn")
          .addEventListener("click", function () {
            openAddPatientModal();
          });

        // Save profile changes
        document
          .querySelector("#profile-edit .btn-primary")
          .addEventListener("click", function () {
            saveProfileChanges();
          });

        // Save new medical record
        document
          .querySelector("#add-record-form .btn-primary")
          .addEventListener("click", function () {
            saveNewMedicalRecord();
          });
      }

      // Patient search
      function initializePatientSearch() {
        // Main search bar
        document
          .querySelector(".header-actions .search-bar input")
          .addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
              const searchTerm = this.value.toLowerCase();
              searchAllSections(searchTerm);
            }
          });

        // Patient section search
        document
          .querySelector("#patients-section .search-bar input")
          .addEventListener("keyup", function (e) {
            const searchTerm = this.value.toLowerCase();
            filterPatientsTable(searchTerm);
          });

        // Medical records search
        document
          .getElementById("patient-search")
          .addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
              const searchTerm = this.value.toLowerCase();
              searchPatientRecords(searchTerm);
            }
          });
      }

      // Improved record type selection function
      function initializeRecordTypeSelection() {
        document
          .getElementById("record-type-select")
          .addEventListener("change", function () {
            const selectedType = this.value;

            // Hide all forms
            document.querySelectorAll(".add-record-form").forEach((form) => {
              form.style.display = "none";
            });

            // Show the selected form
            const formId = selectedType + "-form";
            const selectedForm = document.getElementById(formId);

            if (selectedForm) {
              selectedForm.style.display = "grid";

              // Set all date inputs to today's date
              const today = new Date().toISOString().split("T")[0]; // Format: YYYY-MM-DD
              selectedForm
                .querySelectorAll('input[type="date"]')
                .forEach((dateInput) => {
                  if (!dateInput.value) {
                    dateInput.value = today;
                  }
                });

              // Show a confirmation message
              showNotification(
                `Form for ${
                  document.querySelector(
                    `#record-type-select option[value="${selectedType}"]`
                  ).textContent
                } is ready.`,
                "info"
              );

              // Calculate BMI if information form and both height and weight are filled
              if (selectedType === "information") {
                const weightInput = selectedForm.querySelector(
                  'input[placeholder="e.g., 75.5"]'
                );
                const heightInput = selectedForm.querySelector(
                  'input[placeholder="e.g., 175"]'
                );

                if (weightInput.value && heightInput.value) {
                  // Trigger BMI calculation
                  const event = new Event("input");
                  weightInput.dispatchEvent(event);
                }
              }
            } else {
              // Fallback to information form if the selected form doesn't exist
              document.getElementById("information-form").style.display =
                "grid";
              showNotification(
                `Form for ${selectedType} is not available. Using default template.`,
                "warning"
              );
            }
          });
      }

      // Initialize action buttons
      function initializeActionButtons() {
        // Appointment action buttons
        document
          .querySelectorAll(".appointment-actions .btn")
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const action = this.textContent.trim();
              const appointmentElement = this.closest(".appointment-item");
              const patientName =
                appointmentElement.querySelector(".patient-name").textContent;
              const appointmentType =
                appointmentElement.querySelector(
                  ".appointment-type"
                ).textContent;

              if (action === "View Details") {
                viewAppointmentDetails(patientName, appointmentType);
              } else if (action === "Start") {
                startAppointment(patientName, appointmentType);
              }
            });
          });

        // Patient list action buttons
        document.querySelectorAll(".patient-actions .btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const action = this.textContent.trim();
            const patientRow = this.closest("tr");
            const patientId =
              patientRow.querySelector("td:first-child").textContent;
            const patientName =
              patientRow.querySelector("td:nth-child(2)").textContent;

            if (action === "View") {
              viewPatientDetails(patientId, patientName);
            } else if (action === "Records") {
              viewPatientRecords(patientId, patientName);
            }
          });
        });

        // Medical tests action buttons
        document.querySelectorAll("#medical-tests .btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const testRow = this.closest("tr");
            const testName =
              testRow.querySelector("td:first-child").textContent;
            const testDate =
              testRow.querySelector("td:nth-child(2)").textContent;

            viewFullLabReport(testDate, testName);
          });
        });

        // X-rays action buttons
        document.querySelectorAll("#x-rays .btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const xrayRow = this.closest("tr");
            const xrayType =
              xrayRow.querySelector("td:first-child").textContent;
            const xrayDate =
              xrayRow.querySelector("td:nth-child(2)").textContent;

            viewFullLabReport(xrayDate, xrayType);
          });
        });

        // Medication action buttons
        document.querySelectorAll("#medications .btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const action = this.textContent.trim();
            const medicationRow = this.closest("tr");
            const medicationName =
              medicationRow.querySelector("td:first-child").textContent;

            if (action === "Edit") {
              editMedication(medicationName);
            } else if (action === "Stop") {
              stopMedication(medicationName);
            }
          });
        });

        // Profile picture change button
        document
          .querySelector(".profile-sidebar .btn")
          .addEventListener("click", function () {
            changeProfilePicture();
          });

        // AI Assistant button
        document
          .querySelector(".ai-assistant")
          .addEventListener("click", function () {
            openAIAssistant();
          });
      }

      // Helper Functions

      // Patient Table Rendering
      function renderPatientTable(patientList) {
        const tableBody = document.querySelector(".patients-list tbody");

        if (patientList.length === 0) {
          // Display a message when no patients match the search
          const noResultsRow = document.createElement("tr");
          noResultsRow.innerHTML = `<td colspan="7" style="text-align: center; padding: 20px;">No patients found matching your search criteria.</td>`;
          tableBody.innerHTML = "";
          tableBody.appendChild(noResultsRow);
          return;
        }

        tableBody.innerHTML = "";

        patientList.forEach((patient) => {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${patient.id}</td>
      <td>${patient.name}</td>
      <td>${patient.age}</td>
      <td>${patient.gender}</td>
      <td>${formatDate(patient.lastVisit)}</td>
      <td>${patient.condition}</td>
      <td class="patient-actions">
        <button class="btn btn-sm">View</button>
        <button class="btn btn-sm">Records</button>
      </td>
    `;
          tableBody.appendChild(row);
        });

        // Reinitialize action buttons
        document.querySelectorAll(".patient-actions .btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const action = this.textContent.trim();
            const patientRow = this.closest("tr");
            const patientId =
              patientRow.querySelector("td:first-child").textContent;
            const patientName =
              patientRow.querySelector("td:nth-child(2)").textContent;

            if (action === "View") {
              viewPatientDetails(patientId, patientName);
            } else if (action === "Records") {
              viewPatientRecords(patientId, patientName);
            }
          });
        });
      }

      // Filter patients table based on search term
      function filterPatientsTable(searchTerm) {
        const filteredPatients = patients.filter((patient) => {
          return (
            patient.id.toLowerCase().includes(searchTerm) ||
            patient.name.toLowerCase().includes(searchTerm) ||
            patient.condition.toLowerCase().includes(searchTerm)
          );
        });

        renderPatientTable(filteredPatients);

        // Show search status
        if (searchTerm) {
          showNotification(
            `Found ${filteredPatients.length} patients matching "${searchTerm}"`,
            "info"
          );
        }
      }

      // Search all dashboard sections
      function searchAllSections(searchTerm) {
        // This would be more comprehensive in a real app
        // For now, just search patients
        filterPatientsTable(searchTerm);

        // Show which sections were searched
        showNotification(
          `Searching for "${searchTerm}" across all sections`,
          "info"
        );

        // Navigate to patients section to show results
        showSection("patients-section");
      }

      // Search for a specific patient's records
      function searchPatientRecords(searchTerm) {
        const foundPatient = patients.find(
          (patient) =>
            patient.id.toLowerCase().includes(searchTerm) ||
            patient.name.toLowerCase().includes(searchTerm)
        );

        if (foundPatient) {
          displayPatientRecords(foundPatient.id);
          showNotification(
            `Loaded records for ${foundPatient.name}`,
            "success"
          );
        } else {
          showNotification(
            `No patient found matching "${searchTerm}"`,
            "error"
          );
        }
      }

      // Display patient records with all record types
      function displayPatientRecords(patientId) {
        const patient = patients.find((p) => p.id === patientId);

        if (!patient) {
          showNotification("Patient not found", "error");
          return;
        }

        // Update patient info section
        const patientInfo = document.querySelector(".patient-info");
        patientInfo.innerHTML = `
          <div>
            <h4>Patient Information</h4>
            <p><strong>Name:</strong> ${patient.name}</p>
            <p><strong>ID:</strong> ${patient.id}</p>
            <p><strong>DOB:</strong> ${formatDate(patient.dob)} (${
          patient.age
        } years)</p>
            <p><strong>Gender:</strong> ${patient.gender}</p>
          </div>
          <div>
            <p><strong>Phone:</strong> ${patient.phone}</p>
            <p><strong>Email:</strong> ${patient.email}</p>
            <p><strong>Address:</strong> ${patient.address}</p>
            <p><strong>Insurance:</strong> ${patient.insurance}</p>
          </div>
        `;

        // Check if patient has records
        if (!medicalRecords[patientId]) {
          // Patient has no records yet, create empty data
          medicalRecords[patientId] = {};
          showNotification(
            "No medical records found for this patient.",
            "info"
          );
        }

        // Update all record sections
        updateMedicationsTab(patientId);
        updateAllergiesTab(patientId);
        updateConditionsTab(patientId);
        updateTestsTab(patientId);
        updateXraysTab(patientId);
        updateAppointmentsTab(patientId);
        updateNotesTab(patientId);

        // Switch to Medical Records section
        showSection("medical-records-section");

        // Reinitialize action buttons
        initializeActionButtons();
      }

      // Open AI Assistant
      function openAIAssistant() {
        const chatContainer = document.createElement("div");
        chatContainer.style.cssText = `
          display: flex;
          flex-direction: column;
          height: 300px;
        `;

        const chatHistory = document.createElement("div");
        chatHistory.style.cssText = `
          flex: 1;
          overflow-y: auto;
          padding: 10px;
          background-color: #f8f9fa;
          border-radius: 4px;
          margin-bottom: 10px;
        `;

        chatHistory.innerHTML = `
          <div style="background-color: #e3f2fd; padding: 10px; border-radius: 10px 10px 10px 0; margin-bottom: 10px;">
            <p style="margin: 0;"><strong>AI Assistant:</strong> Hello Dr. Smith! How can I help you today?</p>
          </div>
        `;

        const inputContainer = document.createElement("div");
        inputContainer.style.cssText = `
          display: flex;
          gap: 10px;
        `;

        const chatInput = document.createElement("input");
        chatInput.type = "text";
        chatInput.placeholder = "Type your question here...";
        chatInput.style.cssText = `
          flex: 1;
          padding: 10px 15px;
          border: 1px solid #ddd;
          border-radius: 4px;
        `;

        const sendButton = document.createElement("button");
        sendButton.textContent = "Send";
        sendButton.className = "btn btn-primary";

        inputContainer.appendChild(chatInput);
        inputContainer.appendChild(sendButton);

        chatContainer.appendChild(chatHistory);
        chatContainer.appendChild(inputContainer);

        const modal = showModal("AI Medical Assistant", chatContainer, [
          {
            text: "Close",
            class: "",
          },
        ]);

        // Focus the input field
        setTimeout(() => chatInput.focus(), 300);

        // Handle send button click
        sendButton.addEventListener("click", function () {
          if (chatInput.value.trim() === "") return;

          // Add user message
          const userMessage = document.createElement("div");
          userMessage.style.cssText = `
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 10px 10px 0 10px;
            margin: 10px 0 10px auto;
            max-width: 80%;
          `;
          userMessage.innerHTML = `<p style="margin: 0;"><strong>You:</strong> ${chatInput.value}</p>`;
          chatHistory.appendChild(userMessage);

          // Scroll to bottom
          chatHistory.scrollTop = chatHistory.scrollHeight;

          // Clear input
          const userQuery = chatInput.value;
          chatInput.value = "";

          // Simulate AI response after a short delay
          setTimeout(() => {
            const aiMessage = document.createElement("div");
            aiMessage.style.cssText = `
              background-color: #e3f2fd;
              padding: 10px;
              border-radius: 10px 10px 10px 0;
              margin-bottom: 10px;
              max-width: 80%;
            `;

            // Generate a contextual response based on the query
            let response = "";
            if (
              userQuery.toLowerCase().includes("medication") ||
              userQuery.toLowerCase().includes("dosage")
            ) {
              response =
                "I can help with medication information. Would you like me to provide guidelines on dosage adjustments for hypertensive patients?";
            } else if (
              userQuery.toLowerCase().includes("patient") ||
              userQuery.toLowerCase().includes("anderson")
            ) {
              response =
                "I see you're working with John Anderson. His latest vitals show improvement in blood pressure but his cholesterol is still slightly elevated.";
            } else if (
              userQuery.toLowerCase().includes("schedule") ||
              userQuery.toLowerCase().includes("appointment")
            ) {
              response =
                "You have 3 remaining appointments today. Your next appointment is with Maria Rodriguez at 10:30 AM for a new patient consultation.";
            } else if (
              userQuery.toLowerCase().includes("report") ||
              userQuery.toLowerCase().includes("test")
            ) {
              response =
                "You have 5 pending test reports. Would you like me to summarize the results or prepare them for your review?";
            } else {
              response =
                "I'm here to help with your medical queries. You can ask me about patient data, medication information, clinical guidelines, or appointment management.";
            }

            aiMessage.innerHTML = `<p style="margin: 0;"><strong>AI Assistant:</strong> ${response}</p>`;
            chatHistory.appendChild(aiMessage);

            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
          }, 1000);
        });

        // Handle Enter key in input
        chatInput.addEventListener("keyup", function (e) {
          if (e.key === "Enter") {
            sendButton.click();
          }
        });
      }

      // Add new patient modal
      function openAddPatientModal() {
        const addPatientForm = createAddPatientForm();

        showModal("Add New Patient", addPatientForm, [
          {
            text: "Cancel",
            class: "btn-danger",
          },
          {
            text: "Save Patient",
            class: "btn-primary",
            handler: () => {
              // Get form data
              const name = addPatientForm.querySelectorAll("input")[0].value;
              const dob = addPatientForm.querySelectorAll("input")[1].value;
              const gender = addPatientForm.querySelector("select").value;

              if (!name || !dob || !gender) {
                showNotification("Please fill in all required fields", "error");
                return;
              }

              // Calculate age
              const age = calculateAge(dob);

              // Get other fields
              const phone = addPatientForm.querySelectorAll("input")[2].value;
              const email = addPatientForm.querySelectorAll("input")[3].value;
              const address = addPatientForm.querySelector("textarea").value;
              const insurance =
                addPatientForm.querySelectorAll("input")[4].value;
              const condition =
                addPatientForm.querySelectorAll("input")[5].value;

              // Generate patient ID (next in sequence)
              const patientId =
                "P-" + String(patients.length + 1).padStart(3, "0");

              // Create new patient object
              const newPatient = {
                id: patientId,
                name: name,
                age: age,
                gender: gender,
                dob: dob,
                lastVisit: new Date().toISOString().split("T")[0],
                condition: condition || "New Patient",
                phone: phone || "(555) 000-0000",
                email:
                  email ||
                  name.toLowerCase().replace(" ", ".") + "@example.com",
                address: address || "No address provided",
                insurance: insurance || "Pending",
              };

              // Add to patients array
              patients.push(newPatient);

              // Update UI
              renderPatientTable(patients);

              showNotification("New patient added successfully!", "success");
            },
          },
        ]);
      }

      // Save profile changes
      function saveProfileChanges() {
        // Get form data
        const formElements = document.querySelectorAll(
          "#profile-edit .form-group input, #profile-edit .form-group select, #profile-edit .form-group textarea"
        );

        // Update doctor profile object
        doctorProfile.name = formElements[0].value;
        doctorProfile.email = formElements[1].value;
        doctorProfile.phone = formElements[2].value;
        doctorProfile.dob = formElements[3].value;
        doctorProfile.license = formElements[4].value;
        doctorProfile.specialty = formElements[5].value;
        doctorProfile.department = formElements[6].value;
        doctorProfile.office = formElements[7].value;
        doctorProfile.education = formElements[8].value;
        doctorProfile.residency = formElements[9].value;
        doctorProfile.certification = formElements[10].value;
        doctorProfile.languages = formElements[11].value;
        doctorProfile.workingHours = formElements[12].value;
        doctorProfile.consultationDuration = formElements[13].value;
        doctorProfile.availableForEmergency = formElements[14].value;

        // Update profile view
        document.querySelector(".profile-name").textContent =
          doctorProfile.name;
        document.querySelector(".profile-specialty").textContent =
          doctorProfile.specialty;

        // Update personal information section
        const personalInfoSection = document.querySelector(
          "#profile-view div:nth-child(2)"
        );
        personalInfoSection.innerHTML = `
          <div>
            <p><strong>Full Name:</strong> ${doctorProfile.name}</p>
            <p><strong>Email:</strong> ${doctorProfile.email}</p>
            <p><strong>Phone:</strong> ${doctorProfile.phone}</p>
            <p><strong>Date of Birth:</strong> ${formatDate(
              doctorProfile.dob
            )}</p>
          </div>
          <div>
            <p><strong>Medical License:</strong> ${doctorProfile.license}</p>
            <p><strong>Specialty:</strong> ${doctorProfile.specialty}</p>
            <p><strong>Department:</strong> ${doctorProfile.department}</p>
            <p><strong>Office Location:</strong> ${doctorProfile.office}</p>
          </div>
        `;

        // Update professional information section
        const professionalInfoSection = document.querySelector(
          "#profile-view div:nth-child(4)"
        );
        professionalInfoSection.innerHTML = `
          <p><strong>Education:</strong> ${doctorProfile.education}</p>
          <p><strong>Residency:</strong> ${doctorProfile.residency}</p>
          <p><strong>Board Certification:</strong> ${doctorProfile.certification}</p>
          <p><strong>Languages:</strong> ${doctorProfile.languages}</p>
        `;

        // Update schedule information section
        const scheduleInfoSection = document.querySelector(
          "#profile-view div:nth-child(6)"
        );
        scheduleInfoSection.innerHTML = `
          <p><strong>Working Hours:</strong> ${doctorProfile.workingHours}</p>
          <p><strong>Consultation Duration:</strong> ${doctorProfile.consultationDuration}</p>
          <p><strong>Available for Emergency:</strong> ${doctorProfile.availableForEmergency}</p>
        `;

        // Show success notification
        showNotification("Profile changes saved successfully!", "success");

        // Switch back to view mode
        document.getElementById("profile-view").style.display = "block";
        document.getElementById("profile-edit").style.display = "none";
      }

      // Enhanced save new medical record function with data persistence
      function saveNewMedicalRecord() {
        // Get the selected record type
        const recordType = document.getElementById("record-type-select").value;
        const formElement = document.getElementById(recordType + "-form");
        const patientSelect = document.querySelector("#add-record-form select");
        const patientOption =
          patientSelect.options[patientSelect.selectedIndex];

        if (!formElement) {
          showNotification("Error: Form not found.", "error");
          return;
        }

        // Check if patient is selected
        if (patientSelect.selectedIndex === 0) {
          showNotification("Please select a patient.", "error");
          patientSelect.style.borderColor = "#e74c3c";
          return;
        } else {
          patientSelect.style.borderColor = "#ddd";
        }

        // Basic form validation
        const requiredFields = formElement.querySelectorAll("[required]");
        let isValid = true;

        requiredFields.forEach((field) => {
          if (!field.value.trim()) {
            field.style.borderColor = "#e74c3c";
            isValid = false;
          } else {
            field.style.borderColor = "#ddd";
          }
        });

        if (!isValid) {
          showNotification("Please fill in all required fields.", "error");
          return;
        }

        // Extract patient ID from option text (format: "John Anderson (P-001)")
        const patientId = patientOption.text.match(/\(([^)]+)\)/)[1];

        // Collect form data based on record type
        const newRecord = collectFormData(recordType, formElement);

        // Add the record to the appropriate data structure
        addRecordToPatientData(patientId, recordType, newRecord);

        // Get form title for the notification message
        const formTitle = document.querySelector(
          `#record-type-select option[value="${recordType}"]`
        ).textContent;

        showNotification(
          `New ${formTitle.toLowerCase()} record saved successfully!`,
          "success"
        );

        // Reset form fields
        formElement
          .querySelectorAll('input:not([type="date"]), textarea')
          .forEach((field) => {
            if (field.id !== "bmi-value") {
              // Don't reset readonly BMI field
              field.value = "";
            }
          });

        formElement.querySelectorAll("select").forEach((select) => {
          select.selectedIndex = 0;
        });

        // Return to the patient record view
        document.getElementById("patient-record-view").style.display = "block";
        document.getElementById("add-record-form").style.display = "none";

        // Update the UI with the new record
        displayPatientRecords(patientId);

        // Show the appropriate tab
        updateRecordViewAfterSave(recordType);
      }

      // Collect form data based on record type
      function collectFormData(recordType, formElement) {
        const newRecord = {};

        // Common fields
        if (formElement.querySelector('input[type="date"]')) {
          newRecord.date =
            formElement.querySelector('input[type="date"]').value;
        }

        // Specific fields based on record type
        switch (recordType) {
          case "information":
            newRecord.bloodPressure = formElement.querySelector(
              'input[placeholder="e.g., 120/80"]'
            ).value;
            newRecord.heartRate = formElement.querySelector(
              'input[placeholder="e.g., 72"]'
            ).value;
            newRecord.temperature = formElement.querySelector(
              'input[placeholder="e.g., 36.8"]'
            ).value;
            newRecord.weight = formElement.querySelector(
              'input[placeholder="e.g., 75.5"]'
            ).value;
            newRecord.height = formElement.querySelector(
              'input[placeholder="e.g., 175"]'
            ).value;
            newRecord.bmi = formElement.querySelector("#bmi-value").value;
            newRecord.bloodType = formElement.querySelector("select").value;
            newRecord.notes = formElement.querySelector("textarea").value;
            break;

          case "medication":
            newRecord.name = formElement.querySelector(
              'input[placeholder="Medication name"]'
            ).value;
            newRecord.dosage = formElement.querySelector(
              'input[placeholder="e.g., 10mg"]'
            ).value;
            newRecord.frequency = formElement.querySelector("select").value;
            newRecord.startDate =
              formElement.querySelectorAll('input[type="date"]')[0].value;
            newRecord.endDate =
              formElement.querySelectorAll('input[type="date"]')[1].value ||
              "Ongoing";
            newRecord.instructions =
              formElement.querySelector("textarea").value;
            break;

          case "allergy":
            newRecord.allergen = formElement.querySelector(
              'input[placeholder="Allergen name"]'
            ).value;
            newRecord.severity = formElement.querySelector("select").value;
            newRecord.reaction = formElement.querySelector(
              'input[placeholder="e.g., Anaphylaxis, Hives"]'
            ).value;
            newRecord.onsetDate =
              formElement.querySelector('input[type="date"]').value;
            newRecord.notes = formElement.querySelector("textarea").value;
            break;

          case "condition":
            newRecord.condition = formElement.querySelector(
              'input[placeholder="Medical condition"]'
            ).value;
            newRecord.diagnosisDate =
              formElement.querySelector('input[type="date"]').value;
            newRecord.status = formElement.querySelector("select").value;
            newRecord.treatingPhysician = formElement.querySelector(
              'input[placeholder="Doctor\'s name"]'
            ).value;
            newRecord.notes = formElement.querySelector("textarea").value;
            break;

          case "test":
            newRecord.test = formElement.querySelector(
              'input[placeholder="Medical test name"]'
            ).value;
            newRecord.testDate =
              formElement.querySelector('input[type="date"]').value;
            newRecord.result = formElement.querySelector(
              'input[placeholder="Test result"]'
            ).value;
            newRecord.range = formElement.querySelector(
              'input[placeholder="Normal range for this test"]'
            ).value;
            newRecord.status = formElement.querySelector("select").value;
            newRecord.notes = formElement.querySelector("textarea").value;
            break;

          case "xray":
            newRecord.type = formElement.querySelector(
              'input[placeholder="Type of X-Ray"]'
            ).value;
            newRecord.date =
              formElement.querySelector('input[type="date"]').value;
            newRecord.bodyPart = formElement.querySelector(
              'input[placeholder="Body part imaged"]'
            ).value;
            newRecord.result = formElement.querySelector("select").value;
            newRecord.details = formElement.querySelector("textarea").value;
            break;

          case "appointment":
            newRecord.date =
              formElement.querySelector('input[type="date"]').value;
            newRecord.time =
              formElement.querySelector('input[type="time"]').value;
            newRecord.type = formElement.querySelector("select").value;
            newRecord.notes = formElement.querySelector("textarea").value;
            break;

          case "note":
            newRecord.date =
              formElement.querySelector('input[type="date"]').value;
            newRecord.title = formElement.querySelector(
              'input[placeholder="Title for this note"]'
            ).value;
            newRecord.content = formElement.querySelector("textarea").value;
            break;
        }

        return newRecord;
      }

      // Add record to patient data
      function addRecordToPatientData(patientId, recordType, newRecord) {
        // Initialize patient records if not exists
        if (!medicalRecords[patientId]) {
          medicalRecords[patientId] = {};
        }

        // Map record type to data structure field
        const recordTypeMap = {
          information: "information",
          medication: "medications",
          allergy: "allergies",
          condition: "conditions",
          test: "labResults",
          xray: "xrays",
          appointment: "appointments",
          note: "notes",
        };

        const dataField = recordTypeMap[recordType];

        // Initialize array if not exists
        if (!medicalRecords[patientId][dataField]) {
          medicalRecords[patientId][dataField] = [];
        }

        // Add new record to array
        medicalRecords[patientId][dataField].push(newRecord);

        // If this is an information record, also create a note summarizing the vitals
        if (recordType === "information") {
          if (!medicalRecords[patientId].notes) {
            medicalRecords[patientId].notes = [];
          }

          // Create a note from the information
          const infoNote = {
            date: newRecord.date,
            title: "Vitals Check",
            content: `BP: ${newRecord.bloodPressure}, HR: ${newRecord.heartRate} bpm, Temp: ${newRecord.temperature}°C, Weight: ${newRecord.weight}kg, Height: ${newRecord.height}cm, BMI: ${newRecord.bmi}, Blood Type: ${newRecord.bloodType}\n\nNotes: ${newRecord.notes}`,
          };

          medicalRecords[patientId].notes.push(infoNote);
        }
      }

      // Update medications tab
      function updateMedicationsTab(patientId) {
        const medications = medicalRecords[patientId]?.medications || [];
        const medicationsContent = document.getElementById("medications");

        let medicationsHTML = `
          <h4>Current Medications</h4>
          <table class="patients-list">
            <thead>
              <tr>
                <th>Medication</th>
                <th>Dosage</th>
                <th>Frequency</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        if (medications.length === 0) {
          medicationsHTML += `
            <tr>
              <td colspan="6" style="text-align:center;">No medications found</td>
            </tr>
          `;
        } else {
          medications.forEach((med, index) => {
            medicationsHTML += `
              <tr data-index="${index}">
                <td>${med.name || "N/A"}</td>
                <td>${med.dosage || "N/A"}</td>
                <td>${med.frequency || "N/A"}</td>
                <td>${formatDate(med.startDate) || "N/A"}</td>
                <td>${med.endDate || "N/A"}</td>
                <td>
                  <button class="btn btn-sm edit-medication">Edit</button>
                  <button class="btn btn-sm btn-danger stop-medication">Stop</button>
                </td>
              </tr>
            `;
          });
        }

        medicationsHTML += `
            </tbody>
          </table>
        `;

        medicationsContent.innerHTML = medicationsHTML;

        // Add event listeners to new buttons
        document.querySelectorAll(".edit-medication").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = this.closest("tr").dataset.index;
            editMedication(patientId, index);
          });
        });

        document.querySelectorAll(".stop-medication").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = this.closest("tr").dataset.index;
            stopMedication(patientId, index);
          });
        });
      }

      // Update allergies tab
      function updateAllergiesTab(patientId) {
        // Implementation omitted for brevity - similar to updateMedicationsTab
        // Would render and attach event handlers for allergies table
      }

      // Update conditions tab
      function updateConditionsTab(patientId) {
        // Implementation omitted for brevity - similar to updateMedicationsTab
        // Would render and attach event handlers for conditions table
      }

      // Update tests tab
      function updateTestsTab(patientId) {
        // Implementation omitted for brevity - similar to updateMedicationsTab
        // Would render and attach event handlers for test results table
      }

      // Update X-rays tab
      function updateXraysTab(patientId) {
        // Implementation omitted for brevity - similar to updateMedicationsTab
        // Would render and attach event handlers for x-rays table
      }

      // Update appointments tab
      function updateAppointmentsTab(patientId) {
        // Implementation omitted for brevity - similar to updateMedicationsTab
        // Would render and attach event handlers for appointments table
      }

      // Update notes tab
      function updateNotesTab(patientId) {
        // Implementation omitted for brevity - similar to updateMedicationsTab
        // Would render and attach event handlers for clinical notes
      }

      // View patient details
      function viewPatientDetails(patientId, patientName) {
        const patient = patients.find((p) => p.id === patientId);

        if (!patient) {
          showNotification("Patient details not found", "error");
          return;
        }

        showModal(
          `Patient Details: ${patientName}`,
          `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <p><strong>ID:</strong> ${patient.id}</p>
              <p><strong>Name:</strong> ${patient.name}</p>
              <p><strong>Age:</strong> ${patient.age}</p>
              <p><strong>Gender:</strong> ${patient.gender}</p>
              <p><strong>Date of Birth:</strong> ${formatDate(patient.dob)}</p>
            </div>
            <div>
              <p><strong>Phone:</strong> ${patient.phone}</p>
              <p><strong>Email:</strong> ${patient.email}</p>
              <p><strong>Address:</strong> ${patient.address}</p>
              <p><strong>Insurance:</strong> ${patient.insurance}</p>
              <p><strong>Condition:</strong> ${patient.condition}</p>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <p><strong>Last Visit:</strong> ${formatDate(patient.lastVisit)}</p>
          </div>
          `,
          [
            {
              text: "Edit Details",
              class: "btn-primary",
              handler: () => {
                editPatientDetails(patient);
              },
            },
            {
              text: "View Records",
              class: "btn-primary",
              handler: () => {
                viewPatientRecords(patient.id, patient.name);
              },
            },
            {
              text: "Close",
              class: "",
            },
          ]
        );
      }

      // View patient records
      function viewPatientRecords(patientId, patientName) {
        showNotification(`Loading medical records for ${patientName}`, "info");
        displayPatientRecords(patientId);
      }

      // View appointment details
      function viewAppointmentDetails(
        patientName,
        appointmentType,
        appointmentData = null
      ) {
        let date = "February 25, 2025";
        let notes = "Patient scheduled for routine follow-up.";
        let time = "10:00 AM";

        if (appointmentData) {
          date = formatDate(appointmentData.date);
          time = appointmentData.time || time;
          notes = appointmentData.notes || notes;
        }

        showModal(
          `Appointment Details: ${patientName}`,
          `
          <div>
            <p><strong>Patient:</strong> ${patientName}</p>
            <p><strong>Appointment Type:</strong> ${appointmentType}</p>
            <p><strong>Date:</strong> ${date}</p>
            <p><strong>Time:</strong> ${time}</p>
            <p><strong>Notes:</strong> ${notes}</p>
          </div>
          `,
          [
            {
              text: "Close",
              class: "",
            },
          ]
        );
      }

      // Start appointment
      function startAppointment(patientName, appointmentType) {
        showConfirmDialog(
          `Start appointment with ${patientName} for ${appointmentType}?`,
          function () {
            // In a real app, you would navigate to a consultation interface
            showNotification(
              `Appointment with ${patientName} started. Opening consultation room...`,
              "success"
            );

            // Find patient id from name
            const patient = patients.find((p) => p.name === patientName);

            if (patient) {
              // Simulate redirection to patient records
              setTimeout(() => {
                displayPatientRecords(patient.id);

                // Show a form to add information record
                document.getElementById("patient-record-view").style.display =
                  "none";
                document.getElementById("add-record-form").style.display =
                  "block";

                // Select the patient in the dropdown
                const patientSelect = document.querySelector(
                  "#add-record-form select"
                );
                for (let i = 0; i < patientSelect.options.length; i++) {
                  if (patientSelect.options[i].text.includes(patient.name)) {
                    patientSelect.selectedIndex = i;
                    break;
                  }
                }

                // Select information record type
                const recordTypeSelect =
                  document.getElementById("record-type-select");
                recordTypeSelect.value = "information";

                // Trigger change event to show the information form
                const event = new Event("change");
                recordTypeSelect.dispatchEvent(event);
              }, 1000);
            }
          }
        );
      }

      // Change profile picture
      function changeProfilePicture() {
        // In a real app, you would open a file picker
        const form = document.createElement("form");
        form.innerHTML = `
          <div class="form-group">
            <label>Upload New Photo</label>
            <input type="file" accept="image/*">
          </div>
          <div style="margin-top: 15px;">
            <p>Recommended: Square image, at least 300x300 pixels.</p>
          </div>
        `;

        showModal("Change Profile Picture", form, [
          {
            text: "Cancel",
            class: "",
          },
          {
            text: "Upload",
            class: "btn-primary",
            handler: () => {
              showNotification(
                "Profile picture updated successfully",
                "success"
              );
            },
          },
        ]);
      }

      // Format date string with improved handling of various formats
      function formatDate(dateString) {
        if (!dateString) return "";

        // Check if date is in ISO format (YYYY-MM-DD)
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return dateString; // Return as is if invalid

          const options = { year: "numeric", month: "short", day: "numeric" };
          return date.toLocaleDateString("en-US", options);
        }

        // Handle "Month Day, Year" format
        const monthDayYearMatch = dateString.match(
          /([A-Za-z]+)\s+(\d{1,2}),\s+(\d{4})/
        );
        if (monthDayYearMatch) {
          const [_, month, day, year] = monthDayYearMatch;
          const months = {
            January: 0,
            February: 1,
            March: 2,
            April: 3,
            May: 4,
            June: 5,
            July: 6,
            August: 7,
            September: 8,
            October: 9,
            November: 10,
            December: 11,
            Jan: 0,
            Feb: 1,
            Mar: 2,
            Apr: 3,
            Jun: 5,
            Jul: 6,
            Aug: 7,
            Sep: 8,
            Oct: 9,
            Nov: 10,
            Dec: 11,
          };

          const date = new Date(parseInt(year), months[month], parseInt(day));
          if (!isNaN(date.getTime())) {
            const options = { year: "numeric", month: "short", day: "numeric" };
            return date.toLocaleDateString("en-US", options);
          }
        }

        // If already formatted or not a recognized date, return as is
        return dateString;
      }

      // Format date for input (YYYY-MM-DD)
      function formatDateForInput(dateString) {
        if (!dateString) return new Date().toISOString().split("T")[0];

        // If already in YYYY-MM-DD format
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
          return dateString;
        }

        // Try to parse the date
        const date = new Date(dateString);
        if (!isNaN(date.getTime())) {
          return date.toISOString().split("T")[0];
        }

        // Handle "Month Day, Year" format
        const monthDayYearMatch = dateString.match(
          /([A-Za-z]+)\s+(\d{1,2}),\s+(\d{4})/
        );
        if (monthDayYearMatch) {
          const [_, month, day, year] = monthDayYearMatch;
          const months = {
            January: 0,
            February: 1,
            March: 2,
            April: 3,
            May: 4,
            June: 5,
            July: 6,
            August: 7,
            September: 8,
            October: 9,
            November: 10,
            December: 11,
            Jan: 0,
            Feb: 1,
            Mar: 2,
            Apr: 3,
            Jun: 5,
            Jul: 6,
            Aug: 7,
            Sep: 8,
            Oct: 9,
            Nov: 10,
            Dec: 11,
          };

          const date = new Date(parseInt(year), months[month], parseInt(day));
          if (!isNaN(date.getTime())) {
            return date.toISOString().split("T")[0];
          }
        }

        // Default to today's date if parsing fails
        return new Date().toISOString().split("T")[0];
      }

      // Calculate age from DOB
      function calculateAge(dob) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();

        if (
          monthDiff < 0 ||
          (monthDiff === 0 && today.getDate() < birthDate.getDate())
        ) {
          age--;
        }

        return age;
      }

      // This function would update the patient record view after saving a new record
      function updateRecordViewAfterSave(recordType) {
        // Map record types to tab IDs
        const tabMapping = {
          information: "notes", // Information shows in notes tab
          medication: "medications",
          allergy: "allergies",
          condition: "conditions",
          test: "medical-tests",
          xray: "x-rays",
          appointment: "appointments",
          note: "notes",
        };

        // Get the corresponding tab ID
        const tabId = tabMapping[recordType];

        if (tabId) {
          // Select the appropriate tab
          document.querySelectorAll(".record-tab").forEach((tab) => {
            tab.classList.remove("active");
            if (tab.getAttribute("data-tab") === tabId) {
              tab.classList.add("active");
            }
          });

          // Show the corresponding content
          document.querySelectorAll(".record-content").forEach((content) => {
            content.classList.remove("active");
          });
          document.getElementById(tabId).classList.add("active");
        }
      }

      // Show a specific section
      function showSection(sectionId) {
        // Update navigation menu
        document.querySelectorAll(".menu li").forEach((item) => {
          if (item.getAttribute("data-section") === sectionId) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });

        // Show the section
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.remove("active");
        });
        document.getElementById(sectionId).classList.add("active");
      }

      // Edit medication with specific patient and index
      function editMedication(patientId, index) {
        const medication = medicalRecords[patientId]?.medications?.[index];
        if (!medication) return;

        const form = document.createElement("form");
        form.innerHTML = `
          <div class="form-group">
            <label>Medication Name</label>
            <input type="text" value="${medication.name || ""}" required>
          </div>
          <div class="form-group">
            <label>Dosage</label>
            <input type="text" value="${medication.dosage || ""}" required>
          </div>
          <div class="form-group">
            <label>Frequency</label>
            <select required>
              <option value="Once daily" ${
                medication.frequency === "Once daily" ? "selected" : ""
              }>Once daily</option>
              <option value="Twice daily" ${
                medication.frequency === "Twice daily" ? "selected" : ""
              }>Twice daily</option>
              <option value="Three times daily" ${
                medication.frequency === "Three times daily" ? "selected" : ""
              }>Three times daily</option>
              <option value="Every other day" ${
                medication.frequency === "Every other day" ? "selected" : ""
              }>Every other day</option>
              <option value="Weekly" ${
                medication.frequency === "Weekly" ? "selected" : ""
              }>Weekly</option>
              <option value="As needed" ${
                medication.frequency === "As needed" ? "selected" : ""
              }>As needed</option>
            </select>
          </div>
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" value="${medication.startDate || ""}" required>
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" value="${
              medication.endDate && medication.endDate !== "Ongoing"
                ? medication.endDate
                : ""
            }">
          </div>
          <div class="form-group">
            <label>Instructions</label>
            <textarea>${medication.instructions || ""}</textarea>
          </div>
        `;

        showModal(`Edit Medication: ${medication.name}`, form, [
          {
            text: "Cancel",
            class: "btn-danger",
          },
          {
            text: "Save Changes",
            class: "btn-primary",
            handler: () => {
              // Update medication data
              medicalRecords[patientId].medications[index] = {
                name: form.querySelectorAll("input")[0].value,
                dosage: form.querySelectorAll("input")[1].value,
                frequency: form.querySelector("select").value,
                startDate: form.querySelectorAll("input")[2].value,
                endDate: form.querySelectorAll("input")[3].value || "Ongoing",
                instructions: form.querySelector("textarea").value,
              };

              // Update the UI
              updateMedicationsTab(patientId);

              showNotification(
                `Medication ${medication.name} updated successfully`,
                "success"
              );
            },
          },
        ]);
      }

      // Stop medication with specific patient and index
      function stopMedication(patientId, index) {
        const medication = medicalRecords[patientId]?.medications?.[index];
        if (!medication) return;

        showConfirmDialog(
          `Are you sure you want to discontinue ${medication.name}?`,
          function () {
            const form = document.createElement("form");
            form.innerHTML = `
              <div class="form-group">
                <label>Reason for Discontinuation</label>
                <select required>
                  <option value="">Select a reason</option>
                  <option>Treatment completed</option>
                  <option>Side effects</option>
                  <option>Not effective</option>
                  <option>Alternative medication prescribed</option>
                  <option>Patient request</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Discontinuation Date</label>
                <input type="date" value="${
                  new Date().toISOString().split("T")[0]
                }" required>
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea placeholder="Additional notes about discontinuation..."></textarea>
              </div>
            `;

            showModal("Medication Discontinuation", form, [
              {
                text: "Cancel",
                class: "btn-danger",
              },
              {
                text: "Confirm Discontinuation",
                class: "btn-primary",
                handler: () => {
                  // Update the end date
                  medication.endDate =
                    form.querySelector('input[type="date"]').value;
                  const reason = form.querySelector("select").value;
                  const notes = form.querySelector("textarea").value;

                  // Add a note about discontinuation
                  if (!medicalRecords[patientId].notes) {
                    medicalRecords[patientId].notes = [];
                  }

                  medicalRecords[patientId].notes.push({
                    date: medication.endDate,
                    title: `${medication.name} Discontinuation`,
                    content: `${medication.name} has been discontinued. Reason: ${reason}. ${notes}`,
                  });

                  // Update the UI
                  updateMedicationsTab(patientId);
                  updateNotesTab(patientId);

                  showNotification(
                    `Medication ${medication.name} has been discontinued`,
                    "success"
                  );
                },
              },
            ]);
          }
        );
      }

      // View full lab report
      function viewFullLabReport(
        testDate,
        testName,
        patientId,
        index,
        isXray = false
      ) {
        // Get the test data if available
        let testData = null;
        let resultText = "";
        let interpretationText = "";

        if (patientId && index !== undefined) {
          if (isXray) {
            testData = medicalRecords[patientId]?.xrays?.[index];
            resultText = testData?.result || "Normal";
            interpretationText =
              testData?.details || "All findings within normal limits.";
          } else {
            testData = medicalRecords[patientId]?.labResults?.[index];
            resultText = testData?.result || "Normal";
            interpretationText = "Within normal range.";

            if (
              testName.includes("Cholesterol") &&
              (resultText.includes("210") || parseInt(resultText) > 200)
            ) {
              interpretationText =
                "Slightly elevated. Dietary changes recommended.";
            }
          }
        } else {
          // Fallback if no specific test data
          if (testName === "Blood Glucose") {
            resultText = "95 mg/dL";
            interpretationText = "Within normal range.";
          } else if (testName === "Cholesterol - Total") {
            resultText = "210 mg/dL";
            interpretationText =
              "Slightly elevated. Dietary changes recommended.";
          } else if (testName.includes("X-Ray")) {
            resultText = testName.includes("Abdominal") ? "Abnormal" : "Normal";
            interpretationText = testName.includes("Abdominal")
              ? "Findings suggest mild intestinal distension."
              : "No significant findings. Heart and lungs appear normal.";
          } else {
            resultText = "Normal";
            interpretationText = "All values within normal ranges.";
          }
        }

        showModal(
          `Lab Report: ${testName}`,
          `
          <div>
            <p><strong>Test:</strong> ${testName}</p>
            <p><strong>Date:</strong> ${testDate}</p>
            <p><strong>Ordered by:</strong> Dr. Jane Smith</p>
            <p><strong>Lab:</strong> MedLab Diagnostics</p>
            <hr style="margin: 15px 0;">
            <h4>Results</h4>
            <div style="margin-top: 10px;">
              <p><strong>Result:</strong> ${resultText}</p>
              <p><strong>Normal Range:</strong> ${
                testName.includes("Cholesterol")
                  ? "<200 mg/dL"
                  : testName.includes("Blood Glucose")
                  ? "70-99 mg/dL"
                  : "N/A"
              }</p>
              <p><strong>Interpretation:</strong> ${interpretationText}</p>
            </div>
          </div>
          `,
          [
            {
              text: "Print Report",
              class: "btn-primary",
              handler: () => {
                showNotification("Report sent to printer", "success");
              },
            },
            {
              text: "Close",
              class: "",
            },
          ]
        );
      }

      // Edit patient details
      function editPatientDetails(patient) {
        const form = document.createElement("form");
        form.innerHTML = `
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" value="${patient.name}" required>
          </div>
          <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" value="${patient.dob}" required>
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select required>
              <option value="Male" ${
                patient.gender === "Male" ? "selected" : ""
              }>Male</option>
              <option value="Female" ${
                patient.gender === "Female" ? "selected" : ""
              }>Female</option>
              <option value="Other" ${
                patient.gender === "Other" ? "selected" : ""
              }>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" value="${patient.phone}">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" value="${patient.email}">
          </div>
          <div class="form-group">
            <label>Address</label>
            <textarea>${patient.address}</textarea>
          </div>
          <div class="form-group">
            <label>Insurance Details</label>
            <input type="text" value="${patient.insurance}">
          </div>
          <div class="form-group">
            <label>Medical Condition</label>
            <input type="text" value="${patient.condition}">
          </div>
        `;

        showModal("Edit Patient Details", form, [
          {
            text: "Cancel",
            class: "btn-danger",
          },
          {
            text: "Save",
            class: "btn-primary",
            handler: () => {
              // Update patient data
              patient.name = form.querySelectorAll("input")[0].value;
              patient.dob = form.querySelectorAll("input")[1].value;
              // Recalculate age
              const age = calculateAge(patient.dob);
              patient.age = age;
              patient.gender = form.querySelector("select").value;
              patient.phone = form.querySelectorAll("input")[2].value;
              patient.email = form.querySelectorAll("input")[3].value;
              patient.address = form.querySelector("textarea").value;
              patient.insurance = form.querySelectorAll("input")[4].value;
              patient.condition = form.querySelectorAll("input")[5].value;

              // Update UI
              renderPatientTable(patients);

              showNotification(
                `Patient ${patient.name}'s details updated successfully`,
                "success"
              );
            },
          },
        ]);
      }

      // Initialize the dashboard when page loads
      document.addEventListener("DOMContentLoaded", initializeDashboard);
    </script>
  </body>
</html>
